#!/usr/bin/env bash
# ============================================================
# Local WP-CLI Wrapper
# Part of AI-DDTK - AI Driven Development ToolKit
# ============================================================
#
# PURPOSE:
#   Provides easy access to WP-CLI for Local by Flywheel sites
#   Auto-detects Local paths and PHP binary
#
# USAGE:
#   local-wp <site-name> <wp-cli-command> [args...]
#
# EXAMPLES:
#   local-wp my-site plugin list
#   local-wp my-site option get siteurl
#   local-wp my-site --list
#
# CONFIGURATION:
#   Set these environment variables to override auto-detection:
#
#   export LOCAL_SITES_DIR="$HOME/Local Sites"
#   export LOCAL_RUN_DIR="$HOME/Library/Application Support/Local/run"
#   export WP_CLI_PHAR="/Applications/Local.app/Contents/Resources/extraResources/bin/wp-cli/wp-cli.phar"
#   export PHP_BIN="/path/to/php"
#
# ============================================================

set -e

# Configuration (can be overridden via environment variables)
LOCAL_SITES_DIR="${LOCAL_SITES_DIR:-$HOME/Local Sites}"
LOCAL_RUN_DIR="${LOCAL_RUN_DIR:-$HOME/Library/Application Support/Local/run}"
WP_CLI_PHAR="${WP_CLI_PHAR:-/Applications/Local.app/Contents/Resources/extraResources/bin/wp-cli/wp-cli.phar}"

# Auto-detect PHP binary from Local's lightning-services
detect_php_bin() {
  local services_dir="$HOME/Library/Application Support/Local/lightning-services"

  if [ ! -d "$services_dir" ]; then
    return 1
  fi

  # Find the most recent PHP version
  local php_dir=$(find "$services_dir" -maxdepth 1 -type d -name "php-*" 2>/dev/null | sort -V | tail -1)

  if [ -z "$php_dir" ]; then
    return 1
  fi

  # Detect architecture
  local arch=""
  if [[ "$(uname -m)" == "arm64" ]]; then
    arch="darwin-arm64"
  else
    arch="darwin-x64"
  fi

  local php_binary="$php_dir/bin/$arch/bin/php"

  if [ -f "$php_binary" ]; then
    echo "$php_binary"
    return 0
  fi

  return 1
}

PHP_BIN="${PHP_BIN:-$(detect_php_bin)}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

show_usage() {
  echo -e "${BLUE}Local WP-CLI Wrapper${NC}"
  echo ""
  echo "Usage: local-wp <site-name> <wp-cli-command> [args...]"
  echo ""
  echo "Examples:"
  echo "  local-wp neochrome-timesheets plugin list"
  echo "  local-wp neochrome-timesheets option get siteurl"
  echo "  local-wp neochrome-timesheets core version"
  echo ""
  echo "Available sites:"
  ls -1 "$LOCAL_SITES_DIR" 2>/dev/null | grep -v "^\." | sed 's/^/  - /'
  echo ""
}

if [ $# -lt 1 ]; then
  show_usage
  exit 1
fi

if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
  show_usage
  exit 0
fi

if [ "$1" = "--list" ]; then
  echo -e "${BLUE}Available Local sites:${NC}"
  ls -1 "$LOCAL_SITES_DIR" 2>/dev/null | grep -v "^\." | sed 's/^/  - /'
  exit 0
fi

SITE_NAME="$1"
shift

SITE_PATH="$LOCAL_SITES_DIR/$SITE_NAME/app/public"

if [ ! -d "$SITE_PATH" ]; then
  echo -e "${RED}Error: Site not found: $SITE_NAME${NC}"
  echo ""
  echo -e "${YELLOW}Available sites:${NC}"
  ls -1 "$LOCAL_SITES_DIR" 2>/dev/null | grep -v "^\." | sed 's/^/  - /'
  exit 1
fi

if [ ! -f "$WP_CLI_PHAR" ]; then
  echo -e "${RED}Error: WP-CLI not found at: $WP_CLI_PHAR${NC}"
  echo ""
  echo -e "${YELLOW}To fix, set the WP_CLI_PHAR environment variable:${NC}"
  echo "  export WP_CLI_PHAR=\"/path/to/wp-cli.phar\""
  exit 1
fi

if [ -z "$PHP_BIN" ] || [ ! -f "$PHP_BIN" ]; then
  echo -e "${RED}Error: PHP binary not found${NC}"
  echo ""
  echo -e "${YELLOW}Could not auto-detect PHP from Local's lightning-services.${NC}"
  echo "To fix, set the PHP_BIN environment variable:"
  echo "  export PHP_BIN=\"/path/to/php\""
  echo ""
  echo "Searched in: $HOME/Library/Application Support/Local/lightning-services"
  exit 1
fi

if [ ! -f "$SITE_PATH/wp-config.php" ]; then
  echo -e "${RED}Error: WordPress not found at: $SITE_PATH${NC}"
  exit 1
fi

# Find MySQL socket
SITE_ID=$(grep -r "$SITE_NAME" "$LOCAL_RUN_DIR"/*/conf 2>/dev/null | head -1 | sed 's#.*/run/\([^/]*\)/.*#\1#')

if [ -z "$SITE_ID" ]; then
  echo -e "${RED}Error: Could not find site configuration${NC}"
  exit 1
fi

MYSQL_SOCKET="$LOCAL_RUN_DIR/$SITE_ID/mysql/mysqld.sock"

if [ ! -S "$MYSQL_SOCKET" ]; then
  echo -e "${RED}Error: MySQL socket not found. Is the site running in Local?${NC}"
  exit 1
fi

# Create temporary PHP ini with socket path
PHP_INI_FILE="/tmp/local-wp-${SITE_NAME}.ini"
cat > "$PHP_INI_FILE" << EOF
mysqli.default_socket = "$MYSQL_SOCKET"
pdo_mysql.default_socket = "$MYSQL_SOCKET"
EOF

cd "$SITE_PATH" || exit 1

# Run WP-CLI with custom PHP ini
"$PHP_BIN" -c "$PHP_INI_FILE" "$WP_CLI_PHAR" "$@"

# Cleanup
rm -f "$PHP_INI_FILE"
